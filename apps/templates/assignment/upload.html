{% extends "layouts/assignment_base.html" %}

{% block title %} Dashboard {% endblock %}

<!-- Specific Page CSS goes HERE  -->
{% block stylesheets %}
{% load crispy_forms_tags %}
{% endblock stylesheets %}

{% block content %}

<form id="upload-form" method="post" enctype="multipart/form-data">
    {% csrf_token %}
    <div class="row mb-5">
        <div class="col-sm-5">
            {{ form|crispy }}
            <br>
            <input type="file" name="file" class="form-control"/>
        </div>
    </div>
    <div class="row mb-5">
        <p id="upload-status"></p> <!-- Add an ID to the element that displays the upload status -->
        <div class="col-sm-5">
            <button type="submit" class="btn btn-success">Upload</button>
        </div>
    </div>
</form>

{% endblock content %}

{% block javascripts %}
<script>
    // Add JavaScript code to track the uploading progress
    const form = document.getElementById('upload-form');
    const uploadStatus = document.getElementById('upload-status');

    let uploadInProgress = false; // Keep track of whether an upload is in progress

    form.addEventListener('submit', (event) => {
        event.preventDefault();

        if (uploadInProgress) {
            // If an upload is already in progress, prevent the form submission
            return;
        }

        const formData = new FormData(form);

        const request = new XMLHttpRequest();
        request.open('POST', '/assignment/upload/'); // Replace with your actual upload endpoint

        request.upload.addEventListener('progress', (event) => {
            if (event.lengthComputable) {
                const progress = Math.round((event.loaded / event.total) * 100);
                uploadStatus.textContent = `Uploading: ${progress}%`;
            }
        });

        request.onreadystatechange = function() {
            if (request.readyState === XMLHttpRequest.DONE) {
                if (request.status === 200) {
                    uploadStatus.textContent = 'Upload complete';
                    form.reset(); // Clear the form after successful upload
                } else {
                    uploadStatus.textContent = 'Upload failed';
                }

                uploadInProgress = false; // Reset the flag when the upload is complete
                window.removeEventListener('beforeunload', preventExitDuringUpload); // Remove the event listener
            }
        };

        // Set the flag to indicate that an upload is in progress
        uploadInProgress = true;
        // Add event listener to prevent the user from leaving the page during upload
        window.addEventListener('beforeunload', preventExitDuringUpload);

        request.send(formData);
    });

    function preventExitDuringUpload(event) {
        event.preventDefault();
        event.returnValue = ''; // This is necessary for older browsers
    }
</script>
{% endblock javascripts %}
